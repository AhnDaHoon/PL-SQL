-- 예외처리
-- 1. PREDEFINE EXCEPTION
-- 2. NONPREDEFINE EXCEPTION
-- 3. USER DEFINED EXCEPTION
-- 4.  OTHERS

ACCEPT VNO PROMPT '사번입력:'

DECLARE
	VEMPNO NUMBER := &VNO;
	VENAME VARCHAR2(20);
	VSAL NUMBER;
	VEX1 EXCEPTION; -- 2. NONPREDEFINE EXCEPTION
	VEX2 EXCEPTION; -- 3. USER DEFINED EXCEPTION

	-- PRAGMA: 컴파일러 지시자
	--PRAGMA EXCEPTION_INIT(이름, 에러번호);
	PRAGMA EXCEPTION_INIT(VEX1, -06502);

	VMSG := VARCHAR2(2000); -- 
	VCODE := VARCHAR2(100); --

BEGIN
	-- VSAL := 'SCOTT'; -- 2. NONPREDEFINE EXCEPTION 
	SELECT EMPNO, ENAME, SAL
		INTO VEMPNO, VENAME, VSAL
	FROM EMP
	WHERE EMPNO = VEMPNO;
	--WHERE DEPTNO = 10; -- TOO_MANY_ROWS 확인 WHERE

	IF VSAL < 3000 THEN -- 3. USER DEFINED EXCEPTION
		-- 예외발생
		RAISE VEX2;
	END IF;
	
	DBMS_OUTPUT.PUT_LINE(VEMPNO||'		'||VENAME||'		'||VSAL);

EXCEPTION
-- 1. PREDEFINE EXCEPTION
	-- WHEN	예외명 THEN
		-- 처리할 문장;
		-- 처리할 문장;
	WHEN NO_DATA_FOUND THEN -- 데이터가 없을때 발생한다.
		DBMS_OUTPUT.PUT_LINE('그런 사원은 존재하지 않습니다.');
	WHEN TOO_MANY_ROWS THEN -- SELECT문의 결과가 1개 이상의 행을 리턴하는 경우 발생한다.
		DBMS_OUTPUT.PUT_LINE('해당 사원이 둘 이상입니다.');
	WHEN INVALID_CURSOR THEN -- CURSOR의 OPEN, FETCH를 실행 안했을경우 발생한다.
		DBMS_OUTPUT.PUT_LINE('해당 사원이 둘 이상입니다.');
	WHEN DUP_VAL_ON_INDEX THEN -- UNIQUE 제약을 갖는 컬럼에 중복되는 데이터가 INSERT 될 때 발생한다.
		DBMS_OUTPUT.PUT_LINE('PK, UK 제약이 존재하는 컬럼에 중복된 값은 허용되지 않습니다.');

-- 2. NONPREDEFINE EXCEPTION
	WHEN VEX1 THEN
		DBMS_OUTPUT.PUT_LINE('숫자변수에 문자를 할당할 수 없습니다.');

-- 3. USER DEFINED EXCEPTION
	WHEN VEX2 THEN
		DBMS_OUTPUT.PUT_LINE('급여 3000미만은 출력하지 않습니다.');

-- 4.  모든 예외에 대한 처리, 최상위 EXCEPTION
	WHEN OTHERS THEN
		ROLLBACK; -- 예상치 못한 에러여서 롤백을 한다.
		VMSG := SQLERRM; -- 에러메세지를 변수로 넘겨줌
		VCODE := SQLCODE; -- SQL에러 번호를 변수로 넘겨줌
		-- 에러테이블에 시퀀스와 변수, 현재시간을 INSERT해줌
		INSERT INTO ERRTBL
		VALUES(ERR_SQL.NEXTVAL, VCODE, VMSG, SYSDATE); 
		COMMIT;
		DBMS_OUTPUT.PUT_LINE('예기치 않은 오류 발생');
		DBMS_OUTPUT.PUT_LINE('관리자에게 문의하세요');
		DBMS_OUTPUT.PUT_LINE('구내번호: XXXX');
END;
/


